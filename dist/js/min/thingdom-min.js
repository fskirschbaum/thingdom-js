/**
 * Thingdom API JavaScript Wrapper
 *
 * @author     Andrew Welters <andrew.welters@mts.com>
 * @author     F. Stephen Kirschbaum <stephen.kirschbaum@mts.com>
 * @copyright  2014-2015 MTS Systems
 * @license    http://www.opensource.org/licenses/mit-license.html MIT License
 * @version    1.1
 * @link       https://github.com/thingdomio/thingdom-js
 * @website    https://thingdom.io
 */
(function(){"use strict";var e=this;!function(e){var t=function(){var e=this,t=0,r=null,o=[],s=[],i=function(n,o){return function(s){return 0===t&&(r=s,t=n,o.forEach(function(e){e()})),e}};return e.state=function(){var e=["pending","fulfilled","rejected"];return function(){return e[t]}}(),e.resolve=i(1,o),e.reject=i(2,s),e.then=function(e,i){var a=n(),u=function(e,t){return"function"!=typeof e&&(e=t),function(){setTimeout(function(){try{a.resolve(e(r))}catch(t){a.reject(t)}})}};return e=u(e,function(e){return e}),i=u(i,function(e){throw e}),0===t?(o.push(e),s.push(i)):1===t?e():2===t&&i(),a.restrict()},e.restrict=function(){return{state:e.state,then:e.then}},e},n=function(){return new t};"function"==typeof e.define?e.define("deferred",[],function(){return n}):e.deferred=n}(e),function(t){var n=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0")},function(){return new ActiveXObject("MSXML2.XMLHTTP")}],r=null,o=Object.prototype.hasOwnProperty,s=Array.prototype.forEach,i=function(e,t,n){if(null!==e)if(s&&e.forEach===s)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,i=e.length;i>r;r++)if(r in e&&t.call(n,e[r],r,e)===breaker)return}else for(var a in e)if(o.call(e,a)&&t.call(n,e[a],a,e)===breaker)return},a=function(e){return i(Array.prototype.slice.call(arguments,1),function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])}),e};t.xhr=function(){if(null!==r)return r();for(var e=0,t=n.length;t>e;e++)try{var o=n[e],s=o();if(null!==s)return r=o,s}catch(i){continue}return function(){}},t._xhrResp=function(e){switch(e.getResponseHeader("Content-Type").split(";")[0]){case"text/xml":return e.responseXML;case"text/json":case"application/json":case"text/javascript":case"application/javascript":case"application/x-javascript":return JSON.parse(e.responseText);default:return e.responseText}},t._formData=function(e){var t=[],n=/%20/g;for(var r in e)t.push(encodeURIComponent(r).replace(n,"+")+"="+encodeURIComponent(e[r].toString()).replace(n,"+"));return t.join("&")},t.ajax=function(n){var r=t.xhr(),o,s=0,i=e.deferred();n=a({userAgent:"XMLHttpRequest",lang:"en",type:"GET",data:null,dataType:"application/x-www-form-urlencoded"},n),n.timeout&&(o=setTimeout(function(){r.abort(),n.timeoutFn&&n.timeoutFn(n.url)},n.timeout));var u=function(e){n.success(e)},c=function(e){n.error(e)};i.then(u,c),r.onreadystatechange=function(){4===r.readyState?(o&&clearTimeout(o),r.status<300?(n.dataType.indexOf("json")>=0&&(r.responseJSON=JSON.parse(r.responseText)),n.success&&("pending"===i.state()?i.resolve(t._xhrResp(r)):n.success(t._xhrResp(r),"success",r))):n.error&&("pending"===i.state()?i.reject(r.statusText):n.error(r,r.status,r.statusText)),n.complete&&n.complete(r,r.statusText)):n.progress&&n.progress(++s)};var f=n.url,p=null,d="POST"===n.type||"PUT"===n.type;if(!d&&n.data&&(f+="?"+t._formData(n.data)),r.open(n.type,f),d){var l=n.dataType.indexOf("json")>=0;p=l?JSON.stringify(n.data):t._formData(n.data),r.setRequestHeader("Content-Type",l?"application/json":"application/x-www-form-urlencoded")}r.send(p)}}(e);var t=function(t){var n=this,r="none",o="https://api.thingdom.io/1.1/",s,i;this.responses=[],this.lastError=null,"undefined"!=typeof t&&(s=t);var a=function(e){n.lastError=e},u=function(t,i,u){var c=function(r){var s=t,c=i,f=u;c.token=r.application_token,e.ajax({url:o+s,withCredentials:!0,type:"POST",dataType:"json",data:c,success:function(){},error:function(){},complete:function(e){n.responses.push(e.responseJSON),"token_expired"!==e.responseJSON.response?f(e.responseJSON):a("Your application_token has expired and could not be renewed.")}})};e.ajax({url:o+t,withCredentials:!0,type:"POST",dataType:"json",data:i,success:function(e){"token_expired"!==e.response&&u(e)},error:function(e){u(e)},complete:function(e){n.responses.push(e.responseJSON),"token_expired"===e.responseJSON.response&&f(s,r,c)}})},c=function(e){i=e},f=function(t,n,r){var o;"function"==typeof r&&(o=e.deferred(),o.then(r,r));var s={api_secret:t,device_secret:n},i=function(e){c(e.application_token),"undefined"!=typeof o&&o.resolve(e)};u("token",s,i)};f(s,r);var p=function(e,t){var n=e;this.thing_code=t;var r=function(e,t){var r={};"undefined"==typeof e&&a("Error in feed. You must define a message as a string"),"undefined"!=typeof t&&(r.feed_category=t),r.token=i,r.thing_id=n,r.message=e;var o=function(e){"success"!==e.msg&&a("Error posting to /feed. Server responded: "+e.msg)};u("feed",r,o)},o=function(e,t,r){var o={};("undefined"==typeof e||"undefined"==typeof t)&&this.errors.push("You must specify both a key and value to post to /status"),o.token=i,o.thing_id=n,o.status_array="undefined"!=typeof r?[{name:e,value:t,unit:r}]:[{name:e,value:t}];var s=function(e){"success"!==e.msg&&a("Error posting to /status. Server responded: "+e.msg)};u("status",o,s)},s=function(e){"object"!=typeof e&&a("Error in statusArray. You must pass an array / object with appropriate key value pairs like [ { name: key, value: val, unit: unit } ]");var t={token:i,thing_id:n,status_array:e},r=function(e){"success"!==e.msg&&a("Error posting to /status. Server responded: "+e.msg)};u("status",t,r)};return this.feed=r,this.status=o,this.statusArray=s,this};return this.getThing=function(e,t,n){if("undefined"==typeof r||"undefined"==typeof s||"undefined"==typeof i)return void a("Unable to get Thing, Thingdom requires an API Secret, an Application Token, and a Device Secret.");var o={};if("undefined"==typeof e)return void a("Unable to get Thing. You must define the name for your Thing");o.name=e,"undefined"!=typeof t&&(o.product_type=t),o.token=i;var c=function(e){var t;"success"===e.response?t=new p(e.thing_id,e.code):a("Unable to get thing, server response: "+e.msg),n(t)};u("thing",o,c)},n};e.Thingdom=t}).call(this);
//# sourceMappingURL=./thingdom-min.js.map